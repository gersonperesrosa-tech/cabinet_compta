{% extends "base.html" %}

{% block content %}

<section class="section">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="m-0" style="line-height: 1;">Gestion CFE</h1>

    <div class="d-flex align-items-center gap-3">

        <!-- Recherche dynamique -->
        <input type="text"
               id="searchInput"
               class="form-control"
               placeholder="Rechercher un client…"
               style="width: 220px; height: 38px;">

        <!-- Sélecteur d'année -->
        <form method="GET" class="m-0">
            <select name="annee"
                    class="form-control"
                    style="width: 120px; height: 38px;"
                    onchange="this.form.submit()">
                {% for a in annees %}
                    <option value="{{ a.annee }}" {% if a.annee == annee.annee %}selected{% endif %}>
                        {{ a.annee }}
                    </option>
                {% endfor %}
            </select>
        </form>

    </div>
</div>

<table class="table table-bordered align-middle mt-4">
    <thead class="table-light">
        <tr>
            <th>Client</th>
            <th>CFE N‑1</th>
            <th>Acompte</th>
            <th>Solde</th>
            <th>1447C</th>
            <th style="background:#e9fbe8;">Total CFE</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for cm in cms %}
        <tr>
            <td><strong>{{ cm.client.nom }}</strong></td>

            <td>{{ cm.declaration.cfe_n_1|default:"—" }}</td>

            <td>{{ cm.declaration.acompte_cfe|default:"—" }}
                {% include "partials/statut_badge.html" with statut=cm.declaration.statut_acompte %}
            </td>

            <td>{{ cm.declaration.solde_cfe|default:"—" }}
                {% include "partials/statut_badge.html" with statut=cm.declaration.statut_solde %}
            </td>

            <td>{{ cm.declaration.formulaire_1447c|default:"—" }}
                {% include "partials/statut_badge.html" with statut=cm.declaration.statut_1447c %}
            </td>

            <td style="background:#e9fbe8;">
                {{ cm.total_cfe|floatformat:2 }}
            </td>

            <td>
                <a href="{% url 'cfe_saisie' cm.id %}" class="btn btn-sm btn-outline-primary">
                    Saisir CFE
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

</section>

<!-- Filtre dynamique JS -->
<script>
document.getElementById("searchInput").addEventListener("keyup", function () {
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
        let clientName = row.querySelector("td strong").textContent.toLowerCase();
        row.style.display = clientName.includes(filter) ? "" : "none";
    });
});
</script>

{% endblock %}
