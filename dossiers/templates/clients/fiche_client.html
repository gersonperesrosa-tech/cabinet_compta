{% extends "base.html" %}
{% load static %}

{% block content %}

<section class="section">

<form method="post" id="clientForm" action="{% url 'fiche_client' client.id %}">
    {% csrf_token %}

    <!-- HEADER DE PAGE -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="m-0">Fiche Client ‚Äì {{ client.nom }}</h3>

        <a href="{% url 'liste_clients' %}" class="btn btn-secondary">
            Retour √† la liste
        </a>
    </div>

    <style>
        .page-container {
            padding: 10px 5px 80px;
        }

        .form-section {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .form-section h5 {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 15px;
            color: #374151;
            border-left: 4px solid #0d6efd;
            padding-left: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px 20px;
        }

        .page-footer-fixed {
            position: sticky;
            bottom: 0;
            background: #ffffff;
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            text-align: right;
            box-shadow: 0 -2px 6px rgba(0,0,0,0.05);
        }
    </style>

<div class="page-container">

    <div class="row">

        <!-- COLONNE GAUCHE -->
        <div class="col-lg-7 col-md-12">

            <!-- SECTION 1 : Informations g√©n√©rales -->
            <div class="form-section">
                <h5>Informations g√©n√©rales</h5>

                <div class="form-grid">
                    <div>
                        <label class="form-label">Num√©ro interne</label>
                        {{ form.numero }}
                    </div>

                    <div style="grid-column: span 2;">
                        <label class="form-label">Nom du client</label>
                        {{ form.nom }}
                    </div>

                    <div>
                        <label class="form-label">Forme juridique</label>
                        {{ form.forme_juridique }}
                    </div>

                    <div>
                        <label class="form-label">R√©gime d‚Äôimposition</label>
                        {{ form.regime_imposition }}
                    </div>

                    <div>
                        <label class="form-label">Date de cl√¥ture</label>
                        {{ form.date_cloture }}
                    </div>

                    <div>
                        <label class="form-label">P√©riodicit√© de saisie</label>
                        {{ form.periodicite }}
                    </div>
                </div>
            </div>

            <!-- SECTION 2 : TVA -->
            <div class="form-section">
                <h5>TVA</h5>

                <div class="form-grid">
                    <div>
                        <label class="form-label">R√©gime TVA</label>
                        {{ form.regime_tva }}
                    </div>

                    <div>
                        <label class="form-label">Jour d‚Äô√©ch√©ance TVA</label>
                        {{ form.jour_echeance_tva }}
                    </div>
                </div>

                <a class="btn btn-outline-secondary btn-history"
                   data-bs-toggle="collapse"
                   href="#historiqueTVA">
                    Historique TVA (toutes les ann√©es)
                </a>

                <div class="collapse mt-2" id="historiqueTVA">
                    <div class="list-group">
                        {% for tca in client.tvaclientannee_set.all|dictsortreversed:"annee.annee" %}
                            {% if tca.annee %}
                                <a href="{% url 'tva_historique_client' client.id tca.annee.id %}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">

                                    <div class="d-flex align-items-center gap-2">
                                        <strong>Ann√©e {{ tca.annee.annee }}</strong>

                                        {% if tca.module %}
                                            {% if tca.module.type == "CA3M" %}
                                                <span class="badge bg-primary">Mensuel</span>
                                            {% elif tca.module.type == "CA3T" %}
                                                <span class="badge bg-purple">Trimestriel</span>
                                            {% elif tca.module.type == "CA12" %}
                                                <span class="badge bg-success">Annuel</span>
                                            {% elif tca.module.type == "FR" %}
                                                <span class="badge bg-secondary">Franchise</span>
                                            {% elif tca.module.type == "EXO" %}
                                                <span class="badge bg-warning text-dark">Exon√©r√©</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>

                                    <span class="badge bg-primary">Voir</span>
                                </a>
                            {% else %}
                                <div class="list-group-item text-danger">
                                    ‚ö† Erreur : TVAClientAnnee sans ann√©e associ√©e
                                </div>
                            {% endif %}
                        {% empty %}
                            <p class="text-muted mt-2">Aucune ann√©e TVA configur√©e.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- SECTION 3 : Notes internes -->
            <div class="form-section">
                <h5>Notes internes</h5>
                {{ form.commentaires }}
            </div>

        </div>

        <!-- COLONNE DROITE -->
        <div class="col-lg-5 col-md-12">

<!-- SECTION 4 : Modules activ√©s -->
<div class="form-section">
    <h5>Modules activ√©s</h5>

    <div class="form-grid">

        <label class="form-label">{{ form.module_saisie }} Saisie comptable</label>
        <label class="form-label">{{ form.module_paie }} Module Paie</label>

    </div>

    <div class="mt-3">
        <a href="{% url 'dp_saisie' client.id %}" class="btn btn-outline-secondary w-100">
            üìÅ Dossier Permanent
        </a>
    </div>
</div>

            <!-- SECTION 5 : Archivage -->
            <div class="form-section">
                <h5>Archivage</h5>
                <label class="form-label">{{ form.archive }} Archiv√©</label>
            </div>

            <!-- BOUTON NOTES PRIV√âES (PAGE COMPL√àTE) -->
            <div class="form-section">
                <a href="{% url 'client_notes' client.id %}" class="btn btn-outline-secondary w-100">
                    üìù Notes priv√©es
                </a>
            </div>

        </div>

    </div>

</div>

    <!-- FOOTER FIXE -->
    <div class="page-footer-fixed">
        <button type="submit" class="btn btn-primary px-4">Enregistrer</button>
    </div>

</form>

{% endblock %}
