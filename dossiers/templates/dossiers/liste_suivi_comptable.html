{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Suivi comptable{% endblock %}

{% block content %}

<section class="section">

<div class="container-fluid">

    <!-- Titre + barre de recherche alignée -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Suivi Comptable</h1>

        <div class="input-group" style="max-width: 280px;">
            <span class="input-group-text bg-white">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" id="searchInput" class="form-control" placeholder="Rechercher...">
        </div>
    </div>


    <div class="table-responsive mt-4">

        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Numéro</th>
                    <th>Nom</th>
                    <th>Périodicité</th>
                    <th>Forme juridique</th>
                    <th>Date de clôture</th>
                    <th>Régime TVA actuel</th>
                    <th>Echéance TVA</th>
                    <th>Date MAJ compta</th>
                    <th>Dernier mois saisi</th>
                    <th>Saisi par</th>
                    <th>Vérification</th>
                    <th>Commentaires</th>
                </tr>
            </thead>

            <tbody>
                {% for client in clients %}
                    {% with suivi=suivis|get_item:client.id %}
                    {% with annee=annees|get_item:client.id %}

                    <tr>
                        <td>{{ client.numero }}</td>

                        <td>
                            <a href="{% url 'popup_suivi_comptable' client.id annee %}"
                               class="suivi-link text-decoration-none fw-semibold">
                                {{ client.nom }}
                            </a>
                        </td>

                        <td>{{ client.periodicite }}</td>
                        <td>{{ client.forme_juridique }}</td>
                        <td>{{ client.date_cloture }}</td>
                        <td>{{ client.regime_tva }}</td>
 	                <td>{{ client.jour_echeance_tva|default_if_none:""}}</td>
                        <td>{{ suivi.date_maj_compta|default:"—" }}</td>
                        <td>{{ suivi.dernier_mois_traite|default:"—" }}</td>
                        <td>{{ suivi.saisi_par|default:"—" }}</td>

                        <td>
                            {% if suivi and suivi.verifie %}
                                <i class="bi bi-check2-circle text-success" title="Vérifié"></i>
                            {% else %}
                                <i class="bi bi-x-circle text-danger" title="Non vérifié"></i>
                            {% endif %}
                        </td>

                        <td>{{ suivi.commentaire|default:"—" }}</td>
                    </tr>

                    {% endwith %}
                    {% endwith %}
                {% endfor %}
            </tbody>

        </table>

    </div>
</div>

<script>
document.getElementById("searchInput").addEventListener("input", function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
});
</script>


</section>

<script>
document.addEventListener("click", function(e) {
    const link = e.target.closest(".suivi-link");
    if (!link) return;

    e.preventDefault();

    fetch(link.href, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById("clientModalContent").innerHTML = html;
        new bootstrap.Modal(document.getElementById("clientModal")).show();
    });
});
</script>

<script>
document.addEventListener("submit", function(e) {
    const form = e.target.closest("#suiviComptableForm");
    if (!form) return;

    e.preventDefault();

    fetch(form.action || window.location.href, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {

            // Fermer le popup
            const modal = bootstrap.Modal.getInstance(document.getElementById("clientModal"));
            modal.hide();

            // Recharger la page
            location.reload();
        }
    });
});
</script>


{% endblock %}
