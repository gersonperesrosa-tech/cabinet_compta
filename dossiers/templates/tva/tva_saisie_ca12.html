{% extends "base.html" %}
{% load custom_tags %}

{% block content %}

<section class="section">

<h1>Saisie TVA annuelle – {{ tca.client.nom }} ({{ tca.module.annee.annee }})</h1>

<form method="POST">
    {% csrf_token %}

    <table class="table table-bordered align-middle mt-4">
        <thead>
            <tr>
                <th>Élément</th>
                <th>Montant</th>
                <th>Statut</th>
            </tr>
        </thead>

        <tbody>

            <!-- TVA N-1 -->
            <tr>
                <td><strong>TVA N‑1</strong></td>
                <td>
                    <input type="text" name="tva_n_1" class="form-control"
                           value="{{ declaration.tva_n_1|default_if_none:'' }}">
                    <div class="form-text">
                        Montant calculé automatiquement : {{ n_1_calcule|floatformat:2 }} €
                    </div>
                </td>
                <td></td>
            </tr>

            <!-- Acompte 1 -->
            <tr>
                <td><strong>Acompte 1</strong></td>
                <td>
                    <input type="text" name="tva_acompte_1" class="form-control"
                           value="{{ declaration.tva_acompte_1|default_if_none:'' }}">
                </td>
                <td>
                    <select name="statut_acompte_1" class="form-select">
                        {% for code, label in declaration.TVA_STATUTS %}
                            <option value="{{ code }}"
                                {% if declaration.statut_acompte_1 == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>

            <!-- Acompte 2 -->
            <tr>
                <td><strong>Acompte 2</strong></td>
                <td>
                    <input type="text" name="tva_acompte_2" class="form-control"
                           value="{{ declaration.tva_acompte_2|default_if_none:'' }}">
                </td>
                <td>
                    <select name="statut_acompte_2" class="form-select">
                        {% for code, label in declaration.TVA_STATUTS %}
                            <option value="{{ code }}"
                                {% if declaration.statut_acompte_2 == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>

            <!-- Solde -->
            <tr>
                <td><strong>Solde en N+1</strong></td>
                <td>
                    <input type="text" name="tva_solde" class="form-control"
                           value="{{ declaration.tva_solde|default_if_none:'' }}">
                </td>
                <td>
                    <select name="statut_solde" class="form-select">
                        {% for code, label in declaration.TVA_STATUTS %}
                            <option value="{{ code }}"
                                {% if declaration.statut_solde == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>

            <!-- Commentaire TVA > 1000 -->
            <tr>
                <td><strong>Commentaire (si TVA > 1000)</strong></td>
                <td colspan="2">
                    <textarea name="commentaire_tva_plus_1000"
                              class="form-control"
                              rows="3">{{ declaration.commentaire_tva_plus_1000|default_if_none:'' }}</textarea>
                </td>
            </tr>

        </tbody>
    </table>

    <!-- TOTAL TVA DE L'ANNÉE -->
    <div class="p-3 mt-4 rounded"
         style="background:#f5f7fa; border:1px solid #dce1e7;">
        <strong>Total TVA de l'année :</strong>
        <span style="font-size:1.2rem; font-weight:600;">
            {{ total_tva_annee|floatformat:2 }} €
        </span>
    </div>

    <!-- BOUTONS BAS DE PAGE -->
    <div class="d-flex justify-content-between align-items-center mt-4">

        <!-- Bouton gauche : Retour au Module Annuel -->
        <a href="{% url 'tva_clients_module' tca.module.id %}"
           class="btn btn-outline-secondary">
            Retour au Module Annuel
        </a>

        <div class="d-flex gap-2">

            <!-- Bouton centre : Retour à la gestion CA12 -->
            <a href="{% url 'tva_gestion_ca12' %}?annee={{ tca.annee.id }}"
               class="btn btn-outline-dark">
                Retour
            </a>

            <!-- Bouton droite : Enregistrer -->
            <button type="submit" class="btn btn-primary">
                Enregistrer
            </button>

        </div>

    </div>

</form>

</section>

{% endblock %}
